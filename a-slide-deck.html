<link href="../polymer/polymer.html" rel="import">
<link href="a-slide.html" rel="import">

<polymer-element name="a-slide-deck" extends="body">
  <template>
    <style>
      :host(body) {
        height: 100vh;
        margin: 0;
        overflow: hidden;
        width: 100vw;
      }
    </style>
    <content select="a-slide"></content>
  </template>
  <script>
  (function() {

  Polymer('a-slide-deck', {

    ready: function() {
      this.slides = [].slice.call(this.children);
      this.i = this.getIndexFromUrl();

      this.slides.forEach(function(slide, i) {
        if (i < this.i) slide.setAttribute('history', 'past');
        if (i === this.i) slide.setAttribute('history', 'present');
        if (i > this.i) slide.setAttribute('history', 'future');
      }.bind(this));
    },


    /**
     * Get the slide at the current index.
     */
    get slide() {
      return this.slides[this.i];
    },


    /**
     * Navigate forward in the slide-deck. Check the current slide for
     * additional parts before switching to a different slide.
     */
    forward: function() {
      this.slide.forward() || this.navigate(this.i + 1);
    },


    /**
     * Navigate backward in the slide-deck. Check the current slide for
     * additional parts before switching to a different slide.
     */
    back: function() {
      this.slide.back() || this.navigate(this.i - 1);
    },


    navigate: function(i) {
      if (i < 0 || i > this.slides.length - 1) return;

      var direction = i > this.i ? 1 : -1;

      // Update the history for each slide between this and the target.
      while (i !== this.i) {
        this.slide.setAttribute('history', direction > 0 ? 'past' : 'future');
        this.i += direction;
      }

      this.slide.setAttribute('history', 'present');
      this.updateUrl(i);
    },


    updateUrl: function(i) {
      this.i = i;
      location.hash = this.i + 1;
    },

    getIndexFromUrl: function() {
      var i = Math.floor(location.hash.slice(1));
      return !i || i > this.slides.length ? 0 : i - 1;
    },

    onKeyDown: function(e) {
      switch (e.keyCode) {
        case 32: // Spacebar.
        case 39: // Right arrow key.
          this.forward();
          break;
        case 37: // Left arrow key.
          this.back();
          break;
      }
    },

    onHashChange: function() {
      var i = this.getIndexFromUrl();
      if (i === this.i) return;

      this.navigate(i);
    }

  });


  addEventListener('keydown', function(e) {
    document.body.onKeyDown(e);
  });


  addEventListener('hashchange', function(e) {
    document.body.onHashChange(e);
  });


  }());
  </script>
</polymer-element>
