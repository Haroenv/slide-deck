<link href="../polymer/polymer.html" rel="import">
<link href="a-slide.html" rel="import">

<polymer-element name="a-slide-deck" attributes="width height" extends="body">
<template>
  <style>
    :host(body) {
      height: 100vh;
      margin: 0;
      overflow: hidden;
      position: absolute;
      width: 100vw;
    }
    #container {
      box-sizing: border-box;
      left: 50%;
      position: absolute;
      top: 50%;
    }
  </style>
  <div id="container">
    <content select="a-slide"></content>
  </div>
</template>
<script>
(function() {

  Polymer('a-slide-deck', {

    width: 1280,

    height: 720,

    padding: 80,

    ready: function() {
      this.slides = [].slice.call(this.children);
      this.i = this.getIndexFromUrl();

      this.slides.forEach(function(slide, i) {
        if (i < this.i) slide.setAttribute('history', 'past');
        if (i === this.i) slide.setAttribute('history', 'present');
        if (i > this.i) slide.setAttribute('history', 'future');
      }.bind(this));

      this.onResize();
    },


    /**
     * Get the slide at the current index.
     */
    get slide() {
      return this.slides[this.i];
    },


    /**
     * Navigate forward in the slide-deck. Check the current slide for
     * additional parts before switching to a different slide.
     */
    forward: function() {
      this.slide.forward() || this.navigate(this.i + 1);
    },


    /**
     * Navigate backward in the slide-deck. Check the current slide for
     * additional parts before switching to a different slide.
     */
    back: function() {
      this.slide.back() || this.navigate(this.i - 1);
    },


    navigate: function(i) {
      if (i < 0 || i > this.slides.length - 1) return;

      var direction = i > this.i ? 1 : -1;

      // Update the history for each slide between this and the target.
      while (i !== this.i) {
        this.slide.setAttribute('history', direction > 0 ? 'past' : 'future');
        this.i += direction;
      }

      this.slide.setAttribute('history', 'present');
      this.updateUrl(i);
    },


    updateUrl: function(i) {
      this.i = i;
      location.hash = this.i + 1;
    },


    getIndexFromUrl: function() {
      var i = Math.floor(location.hash.slice(1));
      return !i || i > this.slides.length ? 0 : i - 1;
    },


    onKeyDown: function(e) {
      switch (e.keyCode) {
        case 32: // Spacebar.
        case 39: // Right arrow key.
          this.forward();
          break;
        case 37: // Left arrow key.
          this.back();
          break;
      }
    },


    onHashChange: function() {
      var i = this.getIndexFromUrl();
      if (i === this.i) return;

      this.navigate(i);
    },


    onResize: function() {
      var css = this.$.container.style;

      css.width = (this.width - this.padding) + 'px';
      css.height = (this.height - this.padding) + 'px';
      css.marginLeft = -((this.width / 2) - (this.padding / 2)) + 'px';
      css.marginTop = -((this.height / 2) - (this.padding / 2)) + 'px';

      if (this.clientWidth < this.width || this.clientHeight < this.height) {
        var hRatio = this.clientWidth / this.width;
        var vRatio = this.clientHeight / this.height;
        var scale = Math.min(vRatio, hRatio);

        css.transform = 'scale(' + scale + ')';
      }
      else {
        css.transform = null;
      }
    }

  });


  addEventListener('resize', function(e) {
    document.body.onResize(e);
  });


  addEventListener('keydown', function(e) {
    document.body.onKeyDown(e);
  });


  addEventListener('hashchange', function(e) {
    document.body.onHashChange(e);
  });

}());
</script>
</polymer-element>
